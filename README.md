# 客户端P2P文件传输方案

## 前言

常用的im类软件几乎都带有传输文件的功能，聊天过程中随手发个文件过去已经成为了大多数人的习惯。  
有度即时通客户端一开始就具备文件传输功能，但是出于消息漫游的设计要求，传输的文件需要先发送到服务器，再通知接收方客户端，继而下载文件。对于几兆至十几兆的小文件来说，使用完全没问题，但是对于几十兆甚至上百兆、千兆的文件来说体验完全是灾难。浪费服务器流量不说，速度特别慢，同时也浪费服务器磁盘空间。  
对于大家习惯使用的qq来说，发送文件往往是飞速的，尤其是局域网环境下，传输几个G的文件都不在话下。有度作为办公用的聊天工具文件传送需求更为迫切，必须实现一个高效的文件传输机制，我们称之为P2P文件传输。

## 初次设计

由于我们没有P2P传输的开发经验，初始设计以简单为主，首先考虑的是基本可用，方案比较保守。首先我们解决的问题暂时仅限于优化局域网环境的的传输效率，也就是处于同一个子网的两个客户端能够高效的传输数据。  
局域网环境下传输文件其实有很多种方案可以选择，简单点的就tcp、udp，复杂些的比如FTP协议、SMBA协议等等，我们选择了最简单的方案tcp协议。因为tcp首先支持可靠传输，不用考虑太多传输过程中的异常情况，而且库支持广泛，很容易把业务做出来。  
技术方案定好了我们便实现了一个简单的基于tcp的P2P文件传输功能。客户端双方会通过服务器交换子网的IP地址，由发送方建立文件服务，接收方访问发送方的文件服务并建立tcp连接，并且是基于TLS的安全加密连接，文件分片传输以减少内存压力，实时上报传输进度显示到界面上。  

![](http://TODO)

经过测试，速度相比经服务器转发有大幅提升，可用的目的已经达到了。  
但是对比qq文件传输，速度仍然相差不少，发送一个1G大小的文件时间差不多要两分钟，而qq只在数秒内完成。我们不想止步于此，必须要达到相同级别的效率才能不损失用户体验。于是我们开始了进一步的优化。  

## 建立p2p连接
## 传输协议
## 业务逻辑
